title: 系统调试
date: 2019-01-06 16:24:10
tags:
math: true
---

当在本地或服务器上部署服务了以后，我们会希望程序或服务能最大化地利用系统，达到
性能最优。要查看程序的性能，最关键的两个指标就是内存占用和cpu占用，拿到了这两
个指标，我们再尽可能做程序的优化，或者不能优化的情况下，做一些平衡和取舍。

## cpu指标

cpu占用情况代表了程序消耗的计算资源，我们可以通过
1. nproc命令，查看机器的cpu个数，
2. [top](http://man7.org/linux/man-pages/man1/top.1.html) 命令，查看机器的负载
   情况，包括1分钟的load，5分钟的load和15分钟的load，通
   常如果有8个cpu，那么load在8*1.5=12以内是可以接受的。

## memory指标

内存占用情况代表了程序消耗的内存资源，我们可以通过
1. free命令，查看当前的内存消耗，包括总的内存，已经使用的内存，还可以使用的内
   存，cache，swap等，如果剩下的内存较少但是cache很多，还不要紧，后续使用时会
   从cache里再拿回来，如果剩下内存很少且swap基本占满了，说明程序太吃内存了，这
   时候就需要优化程序了。
2. top命令，上面的free是看总的情况，有时候我们一台服务器上跑了很多程序，想看是
   哪一个占用的多，就可以用top查看。

## 调优思路

### 找到问题

我们通过查看机器和程序的cpu和内存占用情况，可以很快定位哪个程序，有什么样的缺
陷，但现在只是有个粗略的定位，如果想减少cpu消耗或内存消耗，还需要继续深入到程
序里去看哪一部分有问题。

### profile工具

对python程序，可用的profile工具有自带的profile，line_profiler, memory_profiler
[^2]等。根据这些工具，我们可以测试每一个函数甚至每一行代码花的时间，占用的内存情况
，从而找到问题在哪里。

[^2]: https://blog.csdn.net/xiemanr/article/details/72763234

### strace
有的时候，程序可能卡在那里而不知道为什么，我们可以通过
```
strace -p PID
```
查看进程在做什么，具体情况具体分析 [^3]。

[^3]: https://blog.csdn.net/flyingqr/article/details/70598693

## 小结

这篇文章做了一个调试思路的总结，比较宽泛，其实每一个都有很多东西可以深挖，后面
继续填坑吧。
